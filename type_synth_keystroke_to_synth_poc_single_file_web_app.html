<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TypeSynth ‚Äî Keystroke to Sound</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121925; --muted:#9fb3c8; --text:#e8f0fe; --accent:#6ee7ff; --accent2:#a78bfa;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14 0%,#0e1420 100%);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Inter,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
    .card{background:var(--card);border:1px solid #1f2a3a;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    header.card{display:flex;align-items:center;justify-content:space-between;padding:16px 18px}
    header h1{font-size:20px;margin:0}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #2a3650;color:#cde3ff;background:#0f1624}
    .editor{padding:0}
    textarea{width:100%;height:340px;background:transparent;color:var(--text);border:0;resize:vertical;outline:0;font:15px/1.5 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;padding:18px;border-radius:16px}
    .sidebar{padding:14px}
    .row{display:flex;gap:10px;align-items:center;margin:10px 0}
    .row label{font-size:13px;color:var(--muted);min-width:120px}
    input[type="range"]{width:100%}
    select,button,input[type="checkbox"]{background:#0f1624;color:#cde3ff;border:1px solid #2a3650;border-radius:10px;padding:8px 10px;font-size:14px}
    button{cursor:pointer}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .tiny{font-size:12px;color:#8ea4bf}
    .stat{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .badge{border:1px solid #2a3650;border-radius:8px;padding:4px 8px;font-size:12px;color:#b9c9de}
    .footer{padding:12px 16px;color:#8ea4bf;border-top:1px solid #1f2a3a}
    .section-title{font-size:13px;color:#b9c9de;margin:14px 0 6px}
    .mode{padding:10px 14px;border-radius:12px;background:#0e1420;border:1px dashed #2a3650}
    .progress{height:6px;background:#0f1624;border-radius:99px;overflow:hidden}
    .progress>div{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));}
    .kbd{padding:2px 6px;border:1px solid #2a3650;border-radius:6px;background:#0f1624;color:#cde3ff;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <h1>TypeSynth <span class="pill">keystrokes ‚Üí music</span></h1>
      <div class="toolbar">
        <button id="btnStart">üîä Start Audio</button>
        <button id="btnClear">üßπ Clear</button>
        <button id="btnPlay">‚ñ∂Ô∏è Playback</button>
        <button id="btnStop">‚èπ Stop</button>
      </div>
    </header>

    <div class="grid">
      <section class="card editor">
        <textarea id="text" placeholder="Type here‚Ä¶ formal email, love note, or an angry letter ‚Äî each will sound different.\nHotkeys: \n‚Ä¢ Ctrl/Cmd+M toggle Live Mode \n‚Ä¢ Ctrl/Cmd+K toggle Compose Mode (record) \n‚Ä¢ Ctrl/Cmd+P playback\n"></textarea>
        <div class="footer">
          <span class="tiny">Typing speed, punctuation, and CAPS directly shape the sound. Try bursts of !!! or long pauses‚Ä¶</span>
          <div class="stat" id="stats"></div>
        </div>
      </section>

      <aside class="card sidebar">
        <div class="section-title">Modes</div>
        <div class="mode">
          <div class="row"><label>Live Mode</label><input id="liveMode" type="checkbox" checked /></div>
          <div class="row"><label>Compose/Record</label><input id="composeMode" type="checkbox" /></div>
          <div class="row"><label>Quantize playback</label>
            <select id="quantize">
              <option value="0">off</option>
              <option value="0.0625">1/16</option>
              <option value="0.125">1/8</option>
              <option value="0.25">1/4</option>
            </select>
          </div>
          <div class="row"><label>Tempo (BPM)</label><input id="bpm" type="range" min="60" max="180" value="110" /></div>
          <div class="progress"><div id="prog"></div></div>
        </div>

        <div class="section-title">Synth</div>
        <div class="row"><label>Scale</label>
          <select id="scale">
            <option value="major">Major</option>
            <option value="minor">Minor</option>
            <option value="pentatonic">Pentatonic</option>
            <option value="chromatic">Chromatic</option>
          </select>
        </div>
        <div class="row"><label>Root</label>
          <select id="root"></select>
        </div>
        <div class="row"><label>Oscillator</label>
          <select id="osc">
            <option>sine</option>
            <option selected>triangle</option>
            <option>sawtooth</option>
            <option>square</option>
          </select>
        </div>
        <div class="row"><label>Attack</label><input id="attack" type="range" min="0" max="0.4" step="0.01" value="0.01" /></div>
        <div class="row"><label>Release</label><input id="release" type="range" min="0.05" max="1.5" step="0.01" value="0.25" /></div>
        <div class="row"><label>Filter</label><input id="cutoff" type="range" min="200" max="8000" step="50" value="2200" /></div>
        <div class="row"><label>Delay (ms)</label><input id="delay" type="range" min="0" max="600" step="10" value="120" /></div>
        <div class="row"><label>Drive</label><input id="drive" type="range" min="0" max="1" step="0.01" value="0.1" /></div>
        <div class="row"><label>Master Vol</label><input id="master" type="range" min="0" max="1" step="0.01" value="0.6" /></div>

        <div class="section-title">MIDI (optional)</div>
        <div class="row"><button id="btnMIDI">Enable WebMIDI</button></div>
        <div class="row"><label>Output</label><select id="midiOut"></select></div>

        <div class="section-title">Tips</div>
        <div class="tiny">
          ‚Ä¢ Punctuation plays drums. <span class="kbd">.</span>=kick <span class="kbd">!</span>=snare <span class="kbd">?</span>=hat<br/>
          ‚Ä¢ CAPS add grit (drive).<br/>
          ‚Ä¢ Faster typing ‚Üí brighter & louder. Long pauses ‚Üí airy pads.
        </div>
      </aside>
    </div>
  </div>

<script>
(() => {
  // ---------- Audio Graph ----------
  let ctx, master, filter, delay, delayGain, driveNode;
  let lastTime = 0;
  let isPlayingBack = false, playbackStart = 0, playbackTimer = null;
  const recorded = []; // {t, key, upper}

  const A4 = 440;
  const midiToFreq = m => A4 * Math.pow(2, (m-69)/12);
  const roots = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const rootSel = document.getElementById('root');
  roots.forEach((r,i)=>{const o=document.createElement('option');o.value=i;o.textContent=r;o.selected=(i===0);rootSel.appendChild(o)});

  const scales = {
    major:[0,2,4,5,7,9,11],
    minor:[0,2,3,5,7,8,10],
    pentatonic:[0,2,4,7,9],
    chromatic:[0,1,2,3,4,5,6,7,8,9,10,11]
  };

  function initAudio(){
    if(ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    master = ctx.createGain(); master.gain.value = +document.getElementById('master').value;
    filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value = +document.getElementById('cutoff').value;
    delay = ctx.createDelay(1.0); delay.delayTime.value = +document.getElementById('delay').value/1000;
    delayGain = ctx.createGain(); delayGain.gain.value = 0.22;

    // Simple waveshaper for drive
    driveNode = ctx.createWaveShaper();
    function makeCurve(amount){
      const n=1024, curve=new Float32Array(n); const k = amount*100+1;
      for(let i=0;i<n;i++){ const x=i*2/n-1; curve[i]=(1+k)*x/(1+k*Math.abs(x)); }
      return curve;
    }
    driveNode.curve = makeCurve(+document.getElementById('drive').value);

    master.connect(ctx.destination);
    filter.connect(driveNode); driveNode.connect(master);
    // delay send/return
    const send = ctx.createGain(); send.gain.value = 0.25; send.connect(delay); delay.connect(delayGain); delayGain.connect(filter);
    // mix synth directly to filter
    const mix = ctx.createGain(); mix.connect(filter); // we'll connect voices to both mix and send
    window.__TypeSynthBus = {ctx, mix, send};
  }

  class Voice {
    constructor(freq, velocity, oscType){
      this.ctx = ctx;
      this.g = ctx.createGain();
      this.o = ctx.createOscillator();
      this.o.type = oscType;
      this.o.frequency.value = freq;
      this.g.gain.value = 0;
      this.o.connect(this.g);
      // route
      this.g.connect(window.__TypeSynthBus.mix);
      this.g.connect(window.__TypeSynthBus.send);
      this.o.start();
    }
    envOn(a, peak){ const t=ctx.currentTime; this.gainCancel(); this.g.gain.linearRampToValueAtTime(peak, t+a); }
    envOff(r){ const t=ctx.currentTime; this.gainCancel(); this.g.gain.linearRampToValueAtTime(0.0001, t+r); setTimeout(()=>this.stop(), r*1000+50); }
    gainCancel(){ try{ this.g.gain.cancelScheduledValues(ctx.currentTime); }catch(_){} }
    stop(){ try{this.o.stop();}catch(_){ } this.o.disconnect(); this.g.disconnect(); }
  }

  function setParamLinks(){
    document.getElementById('master').addEventListener('input', e=> master && (master.gain.value=+e.target.value));
    document.getElementById('cutoff').addEventListener('input', e=> filter && (filter.frequency.value=+e.target.value));
    document.getElementById('delay').addEventListener('input', e=> delay && (delay.delayTime.value=+e.target.value/1000));
    document.getElementById('drive').addEventListener('input', e=> driveNode && (driveNode.curve=(function(v){const n=1024,curve=new Float32Array(n); const k=v*100+1; for(let i=0;i<n;i++){const x=i*2/n-1; curve[i]=(1+k)*x/(1+k*Math.abs(x));} return curve;})(+e.target.value)));
  }

  // ---------- Mapping ----------
  const letterRegex = /^[a-zA-Z]$/;
  const drums = {
    kick(){
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='sine'; o.frequency.setValueAtTime(140,ctx.currentTime); o.frequency.exponentialRampToValueAtTime(40, ctx.currentTime+0.15);
      g.gain.setValueAtTime(0.9, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.2);
      o.connect(g); g.connect(filter); o.start(); o.stop(ctx.currentTime+0.21);
    },
    snare(){
      const noise = ctx.createBufferSource();
      const buffer = ctx.createBuffer(1, ctx.sampleRate*0.2, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length, 2);
      noise.buffer=buffer;
      const g=ctx.createGain(); g.gain.setValueAtTime(0.6, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.18);
      const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200;
      noise.connect(hp); hp.connect(g); g.connect(filter); noise.start();
    },
    hat(){
      const noise = ctx.createBufferSource();
      const buffer = ctx.createBuffer(1, ctx.sampleRate*0.05, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
      noise.buffer=buffer;
      const g=ctx.createGain(); g.gain.setValueAtTime(0.35, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.05);
      const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000;
      noise.connect(hp); hp.connect(g); g.connect(filter); noise.start();
    }
  };

  function keyToMidi(key){
    const root = +document.getElementById('root').value; // 0=C
    const scaleName = document.getElementById('scale').value;
    const intervals = scales[scaleName];
    const base = 60 + root; // around middle C
    const idx = (key.toLowerCase().charCodeAt(0) - 97); // a-z ‚Üí 0..25
    if(isNaN(idx) || idx < 0 || idx > 25) return 60;
    const degree = idx % intervals.length; const octave = Math.floor(idx / intervals.length);
    return base + intervals[degree] + 12*octave; // walks up octaves across alphabet
  }

  function playLetter(key, upper, intensity){
    const midi = keyToMidi(key);
    const freq = midiToFreq(midi);
    const oscType = document.getElementById('osc').value;
    const v = new Voice(freq, intensity, oscType);
    const atk = +document.getElementById('attack').value;
    const rel = +document.getElementById('release').value;

    // map intensity ‚Üí loudness; uppercase adds drive-like brightness via slightly longer attack
    const amp = Math.min(1, 0.2 + intensity*0.8) * (upper? 1.05:1.0);
    v.envOn(atk*(upper?1.3:1.0), amp);
    v.envOff(rel*(upper?1.15:1.0));
  }

  function playPunctuation(char){
    if(char === '.') drums.kick();
    else if(char === '!') drums.snare();
    else if(char === '?') drums.hat();
  }

  // ---------- Keystroke Handler ----------
  const stats = document.getElementById('stats');
  function setStat(k,v){
    let el = document.querySelector(`[data-k='${k}']`);
    if(!el){ el=document.createElement('span'); el.className='badge'; el.dataset.k=k; stats.appendChild(el);} 
    el.textContent = `${k}: ${v}`;
  }

  function handleKey(e){
    if(!ctx) return;
    // Hotkeys
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='m'){ e.preventDefault(); liveMode.checked=!liveMode.checked; return; }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); composeMode.checked=!composeMode.checked; return; }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='p'){ e.preventDefault(); startPlayback(); return; }

    const now = performance.now();
    const dt = lastTime ? Math.max(1, now - lastTime) : 300;
    lastTime = now;

    // typing intensity: faster ‚Üí higher; cap 0..1
    const intensity = Math.max(0.05, Math.min(1, 240/dt));

    // dynamic filter brightness & master bump
    if(filter){ const base = +document.getElementById('cutoff').value; filter.frequency.setTargetAtTime(base + intensity*3000, ctx.currentTime, 0.03); }

    const upper = (e.key.length===1 && e.key === e.key.toUpperCase() && /[A-Z]/.test(e.key));
    const live = document.getElementById('liveMode').checked;

    if(letterRegex.test(e.key)){
      if(live) playLetter(e.key, upper, intensity);
      recordEvent(e.key, upper);
    } else if(['.','!','?'].includes(e.key)){
      if(live) playPunctuation(e.key);
      recordEvent(e.key, false);
    } else if(e.key==='Backspace'){
      // backspace: small down-chirp
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='triangle'; o.frequency.setValueAtTime(320, ctx.currentTime); o.frequency.exponentialRampToValueAtTime(120, ctx.currentTime+0.08);
      g.gain.setValueAtTime(0.25, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.1);
      o.connect(g); g.connect(filter); o.start(); o.stop(ctx.currentTime+0.11);
      recordEvent('<bk>', false);
    }

    setStat('dt(ms)', dt.toFixed(0));
    setStat('intensity', intensity.toFixed(2));
    setStat('caps', upper? 'YES':'no');
  }

  function recordEvent(key, upper){
    if(!document.getElementById('composeMode').checked) return;
    const t = performance.now();
    recorded.push({t, key, upper});
  }

  function startPlayback(){
    if(recorded.length===0 || !ctx) return;
    isPlayingBack = true; clearTimeout(playbackTimer);
    const q = parseFloat(document.getElementById('quantize').value);
    const bpm = +document.getElementById('bpm').value;
    const beatMs = 60000/bpm;
    const baseT = recorded[0].t;

    playbackStart = performance.now();
    const prog = document.getElementById('prog');

    recorded.forEach((ev,i)=>{
      let at = ev.t - baseT;
      if(q>0){ const qms = q*beatMs; at = Math.round(at/qms)*qms; }
      playbackTimer = setTimeout(()=>{
        if(!isPlayingBack) return;
        if(letterRegex.test(ev.key)) playLetter(ev.key, ev.upper, 0.7);
        else if(['.','!','?'].includes(ev.key)) playPunctuation(ev.key);
        else if(ev.key==='\u003cbk\u003e'){ /* ignored */ }
        const p = Math.min(1, (performance.now()-playbackStart)/Math.max(1, recorded[recorded.length-1].t-baseT));
        prog.style.width = (p*100).toFixed(1)+'%';
      }, at);
    });
  }

  function stopPlayback(){ isPlayingBack=false; clearTimeout(playbackTimer); document.getElementById('prog').style.width='0%'; }

  // ---------- WebMIDI (optional) ----------
  let midiAccess=null, midiOutput=null;
  document.getElementById('btnMIDI').addEventListener('click', async()=>{
    try{
      midiAccess = await navigator.requestMIDIAccess();
      const outSel = document.getElementById('midiOut');
      outSel.innerHTML='';
      midiAccess.outputs.forEach((out)=>{ const o=document.createElement('option'); o.value=out.id; o.textContent=out.name; outSel.appendChild(o); });
      outSel.addEventListener('change',e=>{ midiOutput = [...midiAccess.outputs.values()].find(o=>o.id===e.target.value); });
      midiOutput = midiAccess.outputs.values().next().value || null;
      if(midiOutput) outSel.value = midiOutput.id;
      alert('WebMIDI enabled. Selecting an output will mirror notes as MIDI.');
    }catch(err){ alert('WebMIDI not available in this browser or blocked by permissions.'); }
  });

  // mirror note as MIDI (note on/off), rough mapping inside playLetter
  const _origPlayLetter = playLetter;
  playLetter = function(key, upper, intensity){
    const midi = keyToMidi(key); const vel = Math.round(20 + intensity*100);
    if(midiOutput){ midiOutput.send([0x90, midi, vel]); setTimeout(()=>midiOutput && midiOutput.send([0x80, midi, 0]), Math.max(80, 120 + (upper?40:0))); }
    _origPlayLetter(key, upper, intensity);
  }

  // ---------- Wire up UI ----------
  document.getElementById('btnStart').addEventListener('click', ()=>{ initAudio(); setParamLinks(); document.getElementById('text').focus(); });
  document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('text').value=''; recorded.length=0; });
  document.getElementById('btnPlay').addEventListener('click', startPlayback);
  document.getElementById('btnStop').addEventListener('click', stopPlayback);

  document.getElementById('text').addEventListener('keydown', (e)=>{
    // prevent browser find etc when we use control hotkeys
    if((e.ctrlKey||e.metaKey) && ['m','k','p'].includes(e.key.toLowerCase())) e.preventDefault();
  });
  document.getElementById('text').addEventListener('keyup', (e)=>{
    if(!ctx) return;
    handleKey(e);
  });
})();
</script>
</body>
</html>
